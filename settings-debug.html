<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #e8f5e9; border-color: #4caf50; }
        .error { background-color: #ffebee; border-color: #f44336; }
        .info { background-color: #e3f2fd; border-color: #2196f3; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .log { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fafafa; }
    </style>
</head>
<body>
    <h1>üîß System Settings Debug Tool</h1>
    
    <div class="section info">
        <h3>Current Issue Analysis</h3>
        <p>This tool will help diagnose why the System Settings page shows "Access Denied" while other dashboard pages work fine.</p>
    </div>

    <div class="section">
        <h3>Step 1: Check Authentication Status</h3>
        <button onclick="checkAuth()">Check Current Auth Status</button>
        <div id="authResult"></div>
    </div>

    <div class="section">
        <h3>Step 2: Test Settings API Directly</h3>
        <button onclick="testSettingsAPI()">Test Settings API</button>
        <div id="apiResult"></div>
    </div>

    <div class="section">
        <h3>Step 3: Compare with Other APIs</h3>
        <button onclick="testOtherAPIs()">Test Other Dashboard APIs</button>
        <div id="otherResult"></div>
    </div>

    <div class="section">
        <h3>Step 4: Fix Authentication</h3>
        <button onclick="refreshAuth()">Refresh Authentication</button>
        <button onclick="clearAndRelogin()">Clear Storage & Re-login</button>
        <div id="fixResult"></div>
    </div>

    <div class="section">
        <h3>Debug Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.style.marginBottom = '5px';
            entry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="section ${type}">${message}</div>`;
        }

        async function checkAuth() {
            log('üîç Checking authentication status...');
            
            const token = localStorage.getItem('auth_token'); // Fixed: Use correct token key
            if (!token) {
                showResult('authResult', '‚ùå No authentication token found. You need to login first.', 'error');
                log('‚ùå No token in localStorage');
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const expiry = new Date(payload.exp * 1000);
                const now = new Date();
                const isExpired = expiry <= now;
                const isAdmin = payload.role === 'admin';

                const authInfo = `
                    <strong>Token Analysis:</strong><br>
                    ‚Ä¢ User: ${payload.email}<br>
                    ‚Ä¢ Role: ${payload.role} ${isAdmin ? '‚úÖ' : '‚ùå'}<br>
                    ‚Ä¢ Expires: ${expiry.toLocaleString()}<br>
                    ‚Ä¢ Status: ${isExpired ? '‚ùå EXPIRED' : '‚úÖ Valid'}<br>
                    ‚Ä¢ Token Length: ${token.length} chars
                `;

                if (isExpired) {
                    showResult('authResult', authInfo + '<br><br>üîß <strong>Fix:</strong> Token has expired. Click "Refresh Authentication" below.', 'error');
                    log('‚ùå Token expired');
                } else if (!isAdmin) {
                    showResult('authResult', authInfo + '<br><br>üîß <strong>Fix:</strong> You need admin privileges. Login as admin@school.com', 'error');
                    log('‚ùå Not admin role');
                } else {
                    showResult('authResult', authInfo + '<br><br>‚úÖ Authentication looks good!', 'success');
                    log('‚úÖ Token is valid and user is admin');
                }
            } catch (e) {
                showResult('authResult', '‚ùå Invalid token format. Clear storage and re-login.', 'error');
                log('‚ùå Token parsing error: ' + e.message);
            }
        }

        async function testSettingsAPI() {
            log('üåê Testing settings API...');
            const token = localStorage.getItem('auth_token'); // Fixed: Use correct token key

            if (!token) {
                showResult('apiResult', '‚ùå No token available. Please check authentication first.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/settings', {
                    headers: { 
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`üì° Settings API response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const settings = await response.json();
                    const categories = Object.keys(settings);
                    showResult('apiResult', `
                        ‚úÖ <strong>Settings API Working!</strong><br>
                        ‚Ä¢ Status: ${response.status} OK<br>
                        ‚Ä¢ Categories: ${categories.join(', ')}<br>
                        ‚Ä¢ Total Settings: ${Object.values(settings).reduce((acc, cat) => acc + Object.keys(cat).length, 0)}<br>
                        <br>üéâ <strong>System Settings should work now!</strong>
                    `, 'success');
                    log('‚úÖ Settings API working correctly');
                } else {
                    const errorText = await response.text();
                    showResult('apiResult', `
                        ‚ùå <strong>Settings API Failed</strong><br>
                        ‚Ä¢ Status: ${response.status} ${response.statusText}<br>
                        ‚Ä¢ Error: ${errorText}<br>
                        <br>üîß <strong>Fix:</strong> ${response.status === 401 || response.status === 403 ? 'Authentication issue - refresh your login' : 'Server error - contact support'}
                    `, 'error');
                    log(`‚ùå Settings API failed: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                showResult('apiResult', `‚ùå Network error: ${error.message}`, 'error');
                log(`‚ùå Network error: ${error.message}`);
            }
        }

        async function testOtherAPIs() {
            log('üîÑ Testing other dashboard APIs for comparison...');
            const token = localStorage.getItem('token');

            if (!token) {
                showResult('otherResult', '‚ùå No token available.', 'error');
                return;
            }

            const tests = [
                { name: 'User Profile', url: '/api/user/profile' },
                { name: 'Students', url: '/api/students' },
                { name: 'Teachers', url: '/api/teachers' }
            ];

            let results = '<strong>API Comparison:</strong><br>';
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    results += `‚Ä¢ ${test.name}: ${status} ${response.status}<br>`;
                    log(`${status} ${test.name}: ${response.status}`);
                } catch (error) {
                    results += `‚Ä¢ ${test.name}: ‚ùå Error<br>`;
                    log(`‚ùå ${test.name}: ${error.message}`);
                }
            }

            showResult('otherResult', results, 'info');
        }

        async function refreshAuth() {
            log('üîÑ Refreshing authentication...');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@school.com',
                        password: 'admin123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('auth_token', data.token); // Fixed: Use correct token key
                    showResult('fixResult', `
                        ‚úÖ <strong>Authentication Refreshed!</strong><br>
                        ‚Ä¢ New token generated<br>
                        ‚Ä¢ User: ${data.user.email}<br>
                        ‚Ä¢ Role: ${data.user.role}<br>
                        <br>üöÄ Try accessing System Settings now!
                    `, 'success');
                    log('‚úÖ Authentication refreshed successfully');
                } else {
                    const error = await response.text();
                    showResult('fixResult', `‚ùå Login failed: ${error}`, 'error');
                    log(`‚ùå Login failed: ${error}`);
                }
            } catch (error) {
                showResult('fixResult', `‚ùå Network error: ${error.message}`, 'error');
                log(`‚ùå Login error: ${error.message}`);
            }
        }

        function clearAndRelogin() {
            log('üóëÔ∏è Clearing storage and reloading...');
            localStorage.clear();
            sessionStorage.clear();
            showResult('fixResult', 'üîÑ Storage cleared. Reloading page...', 'info');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // Auto-check auth on load
        window.onload = function() {
            log('üöÄ Settings Debug Tool loaded');
            checkAuth();
        };
    </script>
</body>
</html>
